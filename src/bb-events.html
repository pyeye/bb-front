<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">

<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/hero-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/ripple-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-bottom-animation.html">

<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">


<link rel="import" href="bb-icons.html">



<dom-module id="bb-events">

    <template>

        <style>
            :host {
                display: block;
                position: absolute;
                left: 0;
                height: 100vh;
            }

            app-header {
                background-color: var(--app-primary-color);
                color: #fff;
                --app-header-background-front-layer: {
                    background-image: url(http://localhost/img/static/homepage/events.jpg);
                    background-position: center center;
                };
            }

            app-toolbar.tall {
              height: 250px;
              padding-left: 20px;
            }

            sample-content {
              padding-top: 212px;
            }

           [hidden] {
              display: none;
           }

            [main-title] {
              font-weight: normal;
              -webkit-transform-origin: center top !important;
              transform-origin: center top !important;
              display: -ms-flexbox;
              display: -webkit-flex;
              display: flex;
              justify-content: center;
              font-size: 38px;
            }

            [main-title] iron-icon {
              --iron-icon-fill-color: #FFFFFF;
        --iron-icon-height: 26px;
        --iron-icon-width: 26px;
        margin-top: auto;
        margin-bottom: auto;
            }

            [main-title] .title-label {
              margin-left: 24px;
              margin-right: 24px;
              font-family: 'Oswald', sans-serif !important;
              @apply --paper-font-display1;
              letter-spacing: 6px;
              font-size: 36px;
            }

            [condensed-title] {
              font-weight: normal;
              overflow: hidden;
              text-overflow: ellipsis;
              display: -ms-flexbox;
              display: -webkit-flex;
              display: flex;
              justify-content: center;
              font-size: 20px;
            }

            [condensed-title] .title-label {
              @apply --paper-font-title;
              font-size: 22px;
              margin-left: 24px;
              margin-right: 24px;
              letter-spacing: 4px;
              font-family: 'Oswald', sans-serif !important;
              line-height: 34px;
            }

            [condensed-title] iron-icon {
              --iron-icon-fill-color: #FFFFFF;
              --iron-icon-height: 26px;
              --iron-icon-width: 18px;
            }

            [condensed-title] i {
                font-weight: 100;
                font-style: normal;
            }

            app-toolbar {
                color: white;
            }

            .content[has-content] {
              opacity: 1;
            }

            .content {
                width: 85%;
                margin-top: 16px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 16px;
                @apply --layout-horizontal;
                @apply --layout-wrap;
            }

            paper-material:hover {
                @apply --shadow-elevation-8dp;
            }

            .card {
                @apply --layout-vertical;
                display: inline-block;
                -webkit-flex: 1 1;
                flex: 1 1;
                -webkit-flex-basis: 23%;
                flex-basis: 23%;
                max-width: 23%;
                margin-top: 16px;
                margin-right: 16px;
                box-sizing: border-box;
                border-radius: 2px;
                background-color: var(--app-upper-layer-color);
            }

            .card-header {
                position: relative;
                height: 250px;
            }

            .card-image {
                position: relative;
                width: 100%;
                height: 240px;
            }

            .card-title {
                @apply --paper-font-headline;
                padding-top: 8px;
            }

            .card-content {
                color: #fff;
                padding: 4px 16px 16px 16px;
            }

            .card-row {
                @apply --layout-horizontal;
                @apply --paper-font-subheading;
            }

            .card-actions {
                width: 100%;
                border-top: 1px solid #191919;
                color: #fff;
            }

            .card-actions paper-button {
                float: right;
            }

           


            .card-time {
                border-left: 1px solid #191919;
                padding-left: 16px;
                letter-spacing: 0.8px;
            }

            iron-icon.card-icon {
                margin-bottom: 3px;
                fill: var(--app-primary-color);
            }

            .card-date {
                margin-right: 16px;
                
                letter-spacing: 0.5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .artist-title {
                
                color: var(--app-primary-color);
                display: inline-block;
            }

            .artist-name {
                margin-left: 6px;
                color: #FFFFFF;
                display: inline-block;
            }

            .artist-name:not(:last-of-type):after {
              content: ",";
            }

            

      


            a {
                text-decoration: none;
                color: #fff;
            }

            paper-ripple {
                color: var(--app-primary-color);
            }

            iron-icon {
                color: var(--app-primary-color);
                --iron-icon-height: 20px;
                --iron-icon-width: 20px;
            }


            #ripple {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 100vw;
                background-color: var(--app-lower-layer-color);
                z-index: -5;
            }

            @media (max-width: 1450px) {
              app-toolbar.tall {
                height: 200px;
              }

              .card {
                -webkit-flex-basis: 46%;
                flex-basis: 46%;
                max-width: 46%;
              }

              .content {
                width: 85%;
              }
            }

            @media (max-width: 1050px) {
              [main-title] {
                -webkit-transform-origin: center top !important;
                transform-origin: center top !important;
                font-size: 30px;

              }

              [main-title] .title-label {
                font-size: 30px;
                margin-left: 16px;
                margin-right: 16px;
                letter-spacing: 2px;
              }

              [condensed-title] {
                margin-left: -36px;
                font-size: 20px;
                letter-spacing: 2px;
              }

              [condensed-title] .title-label {
                font-size: 20px;
                margin-left: 16px;
                margin-right: 16px;
              }

              .card {
                -webkit-flex-basis: 46.9%;
                flex-basis: 46.9%;
                max-width: 46.9%;
              }

            }

        @media (max-width: 550px) {

            .artist-name:not(:last-of-type):after {
                margin-left: 0;
            }

            .card {
                -webkit-flex-basis: 100%;
                flex-basis: 100%;
                max-width: 100%;
                margin-right: 0;
            }

            .content {
                width: 95%;
            }
        }
        </style>

        <app-header-layout>
        <app-header id="header"  condenses reveals  effects="waterfall resize-title blend-background parallax-background" >
          <app-toolbar>
            <slot select="[drawer-toggle]"></slot>
            <div condensed-title><iron-icon icon="star"></iron-icon><div class="title-label">СОБЫТИЯ</div><iron-icon icon="star"></iron-icon></div>
          </app-toolbar>
          <app-toolbar class="tall">
            <div main-title><iron-icon icon="star" id="fleft"></iron-icon><div class="title-label">СОБЫТИЯ</div><iron-icon icon="star" id="fright"></iron-icon></div>
          </app-toolbar>
        </app-header>

        <iron-ajax id="ajax" auto url="http://localhost/api/v1/events/" handle-as="json" on-response="handleResponse"></iron-ajax>

        <app-localstorage-document key="events" data={{events}}></app-localstorage-document>

        <div id="ripple"></div>

        <div class="content" has-content$="[[_isDefined(events)]]" id="events">
            <template is="dom-repeat" items="[[events]]" as="event" initial-count="8" on-dom-change="_doAnimation">
                <paper-material class="card" elevation="2" animated="true" on-tap="_heroAnimationHandler">
                    <a class="link" href="/event/[[event.pk]]">
                        <iron-image class="card-image" sizing="cover" preload fade src="[[_getImage(event)]]"></iron-image>
                
                        <div class="card-content">
                            <div class="card-row">
                                <div class="card-date">
                                    <iron-icon class="card-icon" icon="event"></iron-icon> [[event.date.day]] [[event.date.month]], [[event.date.weekday]]
                                </div>
                                <div class="card-time">
                                    <iron-icon class="card-icon" icon="access-time"></iron-icon> [[event.start]]
                                </div>
                            </div>
                            
                            <div class="card-title">[[event.name]]</div>
                            
                            
                           
                           <!-- 
                            <div class="card-row">
                                <div class="artist-title"><iron-icon class="card-icon" icon="music-note"></iron-icon></div> 
                                <template is="dom-repeat" items="[[event.artists]]" as="artist">
                                    <div class="artist-name">[[artist.name]]</div>
                                    
                                </template>
                            </div>
                            -->
                        </div>
                        <paper-ripple></paper-ripple>
                    </a>
                    <div class="card-actions">
                        <paper-button><a class="link" href="/event/[[event.pk]]">Подробнее</a></paper-button>
                        <paper-button on-tap="handleTap">Забить стол</paper-button>
                    </div>
                </paper-material>
            </template>
        </div>
        </app-header-layout>
<blockquote class="instagram-media" data-instgrm-captioned data-instgrm-version="7" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:43.53083434099154% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div> <p style=" margin:8px 0 0 0; padding:0 4px;"> <a href="https://www.instagram.com/p/BVmRLGIlYoc/" style=" color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;" target="_blank">Я хочу ярких красок в сером Лондоне. Я хочу больше красного. Скидка 20% на марочное вино Подробности у банды +79124707197 #борисбар #borisbar</a></p> <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">Публикация от Boris_Bar Челябинск (@boris__bar) <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2017-06-21T10:16:44+00:00">Июн 21 2017 в 3:16 PDT</time></p></div></blockquote>
<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>
        

    </template>

    <script>
        Polymer({

            is: 'bb-events',

            properties: {

                events: {
                    type: Array
                },

                animationConfig: {
                    value: function() {
                        return {
                            'entry': [{
                                name: 'ripple-animation',
                                id: 'events-ripple',
                                toPage: this,
                            }, {
                                name: 'hero-animation',
                                id: 'events-hero',
                                toPage: this,
                            }, {
                               name: 'cascaded-animation',
                               animation: 'slide-from-bottom-animation',
                            },{
                                name: 'fade-in-animation',
                                node: this.$.events,
                                timing: {delay: 250},
                            }, {
                                name: 'fade-in-animation',
                                node: this.$.fleft,
                                timing: {delay: 400},
                            },{
                                name: 'fade-in-animation',
                                node: this.$.fright,
                                timing: {delay: 450},
                            }],
                            'exit': [{
                                name: 'fade-out-animation',
                                node: this,
                            }, {
                                name: 'ripple-animation',
                                id: 'event-ripple',
                                fromPage: this,
                            }]
                        }
                    }
                },

                sharedElements: {
                    value: function() {
                        return {
                            'events-hero': this.$.header,
                            'events-ripple': this.$.ripple,
                        }
                    }
                },
            },

            _heroAnimationHandler: function(e) {
                this.sharedElements['event-ripple'] = e.currentTarget;
            },

            _isDefined: function(events) {
              return events != null;
            },

            _showTitle: function(title) {
                return title == null;
            },

            _getImage: function(event) {
                var img, index;
                if(Object.getOwnPropertyNames(event.poster).length === 0) {
                    index = this._randomInteger(0, event.artists.length - 1);
                    img = event.artists[index].img.thumbnail;
                } else {
                    img = event.poster.thumbnail;
                }
                return img;
            },

            _randomInteger: function(min, max) {
                var rand = min - 0.5 + Math.random() * (max - min + 1)
                rand = Math.round(rand);
                return rand;
            },

            _doAnimation: function(e) {
                var items, itemsArray;
                items = Polymer.dom(this.root).querySelectorAll('.card');
                itemsArray = Array.prototype.slice.call(items);
                this.animationConfig.entry[2].nodes = itemsArray;
            },

            behaviors: [
                Polymer.NeonSharedElementAnimatableBehavior,
                Polymer.IronResizableBehavior
            ],

            ready: function() {
                
            },

            handleTap: function(e) {
                this.fire('open-reservation-dialog', {
                    'event': e.model.event,
                });
            },

            handleResponse: function(request) {
                var response = request.detail.response;
                var index, len, date, options;
                
                options = {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                };

                for (index = 0, len = response.length; index < len; ++index) {
                    date = new Date(response[index].date);            
                    date = date.toLocaleString("ru", options).split(/ |,|\./g);    
                    response[index].date = {
                        'weekday': date[0],
                        'day': date[2],
                        'month': date[3],
                        'original': response[index].date,
                    };
                    if(response[index].sales.length >= 1) {
                        response[index].sale = response[index].sales[0][0];
                    } else {
                        response[index].sale = null;
                    }
                    response[index].start = response[index].start.slice(0, -3);
                };
                this.events = response;
            },

        });
    </script>

</dom-module>
