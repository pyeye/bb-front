<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/hero-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/ripple-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/slide-from-bottom-animation.html">

<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">


<link rel="import" href="bb-icons.html">



<dom-module id="bb-events">

    <template>

        <style>
            :host {
                display: block;
                position: absolute;
                left: 0;
                height: 100vh;
            }

            app-header {
                background-color: var(--app-primary-color);
                color: #fff;
                --app-header-background-front-layer: {
                    background-image: url(http://localhost/img/static/homepage/events.jpg);
                    background-position: center center;
                };
            }

            app-toolbar.tall {
              height: 250px;
              padding-left: 20px;
            }

            sample-content {
              padding-top: 212px;
            }

           [hidden] {
              display: none;
           }

            [main-title] {
              font-weight: normal;
              -webkit-transform-origin: center top !important;
              transform-origin: center top !important;
              display: -ms-flexbox;
              display: -webkit-flex;
              display: flex;
              justify-content: center;
              font-size: 38px;
            }

            [main-title] iron-icon {
              --iron-icon-fill-color: #FFFFFF;
        --iron-icon-height: 26px;
        --iron-icon-width: 26px;
        margin-top: auto;
        margin-bottom: auto;
            }

            [main-title] .title-label {
              margin-left: 24px;
              margin-right: 24px;
              font-family: 'Oswald', sans-serif !important;
              @apply --paper-font-display1;
              letter-spacing: 6px;
              font-size: 36px;
            }

            [condensed-title] {
              font-weight: normal;
              overflow: hidden;
              text-overflow: ellipsis;
              display: -ms-flexbox;
              display: -webkit-flex;
              display: flex;
              justify-content: center;
              font-size: 20px;
            }

            [condensed-title] .title-label {
              @apply --paper-font-title;
              font-size: 22px;
              margin-left: 24px;
              margin-right: 24px;
              letter-spacing: 4px;
              font-family: 'Oswald', sans-serif !important;
              line-height: 34px;
            }

            [condensed-title] iron-icon {
              --iron-icon-fill-color: #FFFFFF;
              --iron-icon-height: 26px;
              --iron-icon-width: 18px;
            }

            [condensed-title] i {
                font-weight: 100;
                font-style: normal;
            }

            app-toolbar {
                color: white;
            }

            .content[has-content] {
              opacity: 1;
            }

            .content {
                width: 85%;
                margin-top: 16px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 16px;
                @apply --layout-horizontal;
                @apply --layout-wrap;
            }

            paper-material:hover {
                @apply --shadow-elevation-8dp;
            }

            .card {
                @apply --layout-vertical;
                display: inline-block;
                -webkit-flex: 1 1;
                flex: 1 1;
                -webkit-flex-basis: 23%;
                flex-basis: 23%;
                max-width: 23%;
                margin-top: 16px;
                margin-right: 16px;
                box-sizing: border-box;
                border-radius: 2px;
                background-color: var(--app-upper-layer-color);
            }

            .card-header {
                position: relative;
                height: 300px;
            }

            .card-image {
                position: relative;
                width: 100%;
                height: 300px;
            }

            .card-title {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
                color: white;
                padding: 16px;
                @apply --paper-font-headline;
                font-weight: 400;
                transition: opacity 0.1s;
            }

            .card-content {
                color: #fff;
                padding: 16px 8px;
            }

            .card-row {
                @apply --layout-horizontal;
                margin: 8px;
            }

            .card-top-box {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 100%);
                @apply --layout-horizontal;
                z-index: 1;
                color: #fff;
            }

            .card-top-date {
                @apply --layout-vertical;
                @apply --layout-flex;
                @apply --paper-font-subhead;
                margin-top: 8px;
                margin-left: 16px;
                font-size: 18px;
            }


            .card-time {
                margin-left: 16px;
                @apply --paper-font-subhead;
            }

            .artist-title {
                
                color: var(--app-primary-color);
                margin-right: 4px;
                display: inline-block;
            }

            .artist-name {
                
                color: #FFFFFF;
                
                margin-right: 4px;
                display: inline-block;
            }

            .artist-name:not(:last-of-type):after {
              content: ",";
            }

            .artist-name:nth-last-of-type(2):before {
              content: none;
            }

      


            a {
                text-decoration: none;
            }

            paper-ripple {
                color: var(--app-primary-color);
            }

            iron-icon {
                color: var(--app-primary-color);
                --iron-icon-height: 20px;
                --iron-icon-width: 20px;
            }


            #ripple {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 100vw;
                background-color: var(--app-lower-layer-color);
                z-index: -5;
            }

            @media (max-width: 1450px) {
              app-toolbar.tall {
                height: 200px;
              }

              .card {
                -webkit-flex-basis: 46%;
                flex-basis: 46%;
                max-width: 46%;
              }
            }

            @media (max-width: 1050px) {
              [main-title] {
                -webkit-transform-origin: center top !important;
                transform-origin: center top !important;
                font-size: 30px;

              }

              [main-title] .title-label {
                font-size: 30px;
                margin-left: 16px;
                margin-right: 16px;
                letter-spacing: 2px;
              }

              [condensed-title] {
                margin-left: -36px;
                font-size: 20px;
                letter-spacing: 2px;
              }

              [condensed-title] .title-label {
                font-size: 20px;
                margin-left: 16px;
                margin-right: 16px;
              }

              .card {
                -webkit-flex-basis: 46.9%;
                flex-basis: 46.9%;
                max-width: 46.9%;
              }

            }

        @media (max-width: 550px) {

            .artist-name:not(:last-of-type):after {
                margin-left: -2px;
            }

            .card {
                -webkit-flex-basis: 100%;
                flex-basis: 100%;
                max-width: 100%;
            }
        }
        </style>

        <app-header id="header"  condenses reveals  effects="waterfall resize-title blend-background parallax-background" >
          <app-toolbar>
            <slot select="[drawer-toggle]"></slot>
            <div condensed-title><iron-icon icon="star"></iron-icon><div class="title-label">СОБЫТИЯ</div><iron-icon icon="star"></iron-icon></div>
          </app-toolbar>
          <app-toolbar class="tall">
            <div main-title><iron-icon icon="star" id="fleft"></iron-icon><div class="title-label">СОБЫТИЯ</div><iron-icon icon="star" id="fright"></iron-icon></div>
          </app-toolbar>
        </app-header>

        <iron-ajax id="ajax" url="http://localhost/api/v1/events/" handle-as="json" on-response="handleResponse"></iron-ajax>

        <app-localstorage-document key="events" data={{events}}></app-localstorage-document>

        <div id="ripple"></div>

        <div class="content" has-content$="[[_isDefined(events)]]" id="events">
            <template is="dom-repeat" items="[[events]]" as="event" initial-count="8" on-dom-change="_doAnimation">
                <paper-material class="card" elevation="2" animated="true" on-tap="_heroAnimationHandler">
                    <a href="/event/[[event.pk]]">
                    <div class="card-header">
                        <div class="card-top-box">
                        <div class="card-top-date">
                            <div>[[event.date.day]] | [[event.date.month]]</div> 
                            <div>[[event.date.weekday]]</div>
                        </div>
                        </div>
                        
                        <iron-image class="card-image" sizing="cover" preload fade src="[[_getImage(event)]]"></iron-image>
                        <div class="card-title">
                            <div class="event-title">[[event.name]]</div>
                            <template is="dom-if" if="[[_showTitle(event.name)]]">
                                <div class="artist-title" >
                                    <template is="dom-repeat" items="[[event.artists]]" as="artist">
                                        <div class="artist-name">[[artist.name]]</div>
                                    </template>
                                </div>
                            </template>
                            
                            
                        </div>
                    </div>
                    <paper-ripple></paper-ripple>
                    </a>
                </paper-material>
            </template>
        </div>

    </template>

    <script>
        Polymer({

            is: 'bb-events',

            properties: {

                events: {
                    type: Array
                },

                animationConfig: {
                    value: function() {
                        return {
                            'entry': [{
                                name: 'ripple-animation',
                                id: 'events-ripple',
                                toPage: this,
                            }, {
                                name: 'hero-animation',
                                id: 'events-hero',
                                toPage: this,
                            }, {
                               name: 'cascaded-animation',
                               animation: 'slide-from-bottom-animation',
                            },{
                                name: 'fade-in-animation',
                                node: this.$.events,
                                timing: {delay: 250},
                            }, {
                                name: 'fade-in-animation',
                                node: this.$.fleft,
                                timing: {delay: 400},
                            },{
                                name: 'fade-in-animation',
                                node: this.$.fright,
                                timing: {delay: 450},
                            }],
                            'exit': [{
                                name: 'fade-out-animation',
                                node: this,
                            }, {
                                name: 'ripple-animation',
                                id: 'event-ripple',
                                fromPage: this,
                            }]
                        }
                    }
                },

                sharedElements: {
                    value: function() {
                        return {
                            'events-hero': this.$.header,
                            'events-ripple': this.$.ripple,
                        }
                    }
                },
            },

            listeners: {
              'bb-render-neon-page': '_renderNeonPage',
            },

            _heroAnimationHandler: function(e) {
                this.sharedElements['event-ripple'] = e.currentTarget;
            },

            _renderNeonPage: function(e) {
              this.$.ajax.generateRequest();
                layout = document.createElement('app-header-layout');
                childNodes = Polymer.dom(this.root).childNodes;
                for (var i = 0; i < childNodes.length; i++) {
                  Polymer.dom(layout).appendChild(childNodes[i]);
                }
                Polymer.dom(this.root).appendChild(layout);
                this.unlisten(this, 'bb-render-neon-page', '_renderNeonPage');
            },

            _isDefined: function(events) {
              return events != null;
            },

            _showTitle: function(title) {
                return title == null;
            },

            _getImage: function(event) {
                var img, index;
                if(Object.getOwnPropertyNames(event.poster).length === 0) {
                    index = this._randomInteger(0, event.artists.length - 1);
                    img = event.artists[index].img.thumbnail;
                } else {
                    img = event.poster.thumbnail;
                }
                return img;
            },

            _randomInteger: function(min, max) {
                var rand = min - 0.5 + Math.random() * (max - min + 1)
                rand = Math.round(rand);
                return rand;
            },

            _doAnimation: function(e) {
                var items, itemsArray;
                items = Polymer.dom(this.root).querySelectorAll('.card');
                itemsArray = Array.prototype.slice.call(items);
                this.animationConfig.entry[2].nodes = itemsArray;
            },

            behaviors: [
                Polymer.NeonSharedElementAnimatableBehavior,
                Polymer.IronResizableBehavior
            ],

            handleResponse: function(request) {
                var response = request.detail.response;
                var index, len, date, date_long, options, options_long;
                
                options = {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'numeric',
                };

                options_long = {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                };


                
                for (index = 0, len = response.length; index < len; ++index) {
                    date = new Date(response[index].date);
                    date_long = new Date(response[index].date);
                    date = date.toLocaleString("ru", options).split(/ |,|\./g);
                    date_long = date_long.toLocaleString("ru", options_long).split(/ |,|\./g);
                    response[index].date = {
                        'weekday': date[0],
                        'day': date[2],
                        'month': date[3],
                        'month_long': date_long[3],
                        'original': response[index].date,
                    };

                    response[index].start = response[index].start.slice(0, -3);
                };
                this.events = response;
            },

        });
    </script>

</dom-module>
